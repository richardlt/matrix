<link rel="import" href="../bower_components/polymer/polymer-element.html">
<script src="../node_modules/socket.io-client/dist/socket.io.slim.js"></script>

<link rel="import" href="./store/store.html">

<dom-module id="matrix-gamepad-socket">
  <script>
    class MatrixGamepadSocket extends ReduxMixin(Polymer.Element) {
      static get is() { return 'matrix-gamepad-socket'; }
      static get properties() { return {}; }
      static get actions() {
        return {
          newFrame: (frame) => { return { type: 'NEW_FRAME', frame }; },
          getSlot: (slot) => { return { type: 'GET_SLOT', slot }; }
        };
      }

      command(cmd) { this._socket.emit('command', cmd); }

      selectSlot(slot) { this._socket.emit('select-slot', slot); }

      ready() {
        super.ready();
        this._socket = io(window.origin);
        this._socket.on('connect', () => { this.selectSlot(0); });
        this._socket.on('frame', (data) => {
          if (data.number == 0) {
            this.dispatch('newFrame', data.pixels);
          }
        });
        this._socket.on('slot', (slot) => { this.dispatch('getSlot', slot); });
        this._socket.on('disconnect', () => { });
      }
    }

    window.customElements.define(MatrixGamepadSocket.is, MatrixGamepadSocket);
  </script>
</dom-module>